version: 2.1

parameters:
  workingdir:
    type: string
    default: "~/main"

executors:
  my-executor:
    resource_class: small
    docker:
      - image: cimg/base:2022.09

jobs:
  build:
    executor: my-executor
    working_directory: << pipeline.parameters.workingdir >>

    steps:
      - checkout

      - persist_to_workspace:
          root: << pipeline.parameters.workingdir >>
          paths:
            - ./
  deploy:
    executor: my-executor
    steps:
      - attach_workspace:
          at: << pipeline.parameters.workingdir >>
      - run: mkdir -p ~/.ssh
      - run:
          name: Add ssh key
          command: |
            echo $SSH_KEY_KEY >> ~/.ssh/$SSH_KEY_ID
      - run: ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts
      - run:
          name: Install rsync
          command: |
            sudo apt update
            sudo apt install rsync
      - run:
          name: Deploy Over SSH
          command: |
            rsync -avz -e "ssh -i ~/.ssh/$SSH_KEY_ID $SSH_USER@SSH_HOST" --progress << pipeline.parameters.workingdir >> $SSH_USER@SSH_HOST:~/$PROJECT_DIRECTORY
      - run: ssh -i ~/.ssh/$SSH_KEY_ID $SSH_USER@SSH_HOST 'chmod -R 755 ~/$PROJECT_DIRECTORY'

workflows:
  version: 2.1
  build-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master