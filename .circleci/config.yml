version: 2.1

executors:
  my-executor:
    resource_class: small
    docker:
      - image: cimg/base:2022.09

jobs:
  build:
    executor: my-executor
    working_directory: ~/$PROJECT_DIRECTORY

    steps:
      - checkout

      - persist_to_workspace:
          root: "~/$PROJECT_DIRECTORY"
          paths:
            - ./$PROJECT_DIRECTORY
  deploy:
    executor: my-executor
    steps:
      - attach_workspace:
          at: ./$PROJECT_DIRECTORY
      - run: mkdir -p ~/.ssh
      - run:
          name: Add ssh key
          command: |
            echo $SSH_KEY_KEY >> ~/.ssh/$SSH_KEY_ID
      - run: ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts
      - run:
          name: Install rsync
          command: |
            sudo apt update
            sudo apt install rsync
      - run:
          name: Deploy Over SSH
          command: |
            rsync -avz -e "ssh -i ~/.ssh/$SSH_KEY_ID $SSH_USER@SSH_HOST" --progress ~/$PROJECT_DIRECTORY $SSH_USER@SSH_HOST:~/$PROJECT_DIRECTORY
      - run: ssh -i ~/.ssh/$SSH_KEY_ID $SSH_USER@SSH_HOST 'chmod -R 755 ~/$PROJECT_DIRECTORY'

workflows:
  version: 2.1
  build-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master